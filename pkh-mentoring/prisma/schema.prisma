generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum StudentStatus {
  PROSPECT
  ENROLLED
  SLOT_SELECTED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum PaymentPlan {
  FULL
  SPLIT_2
  SPLIT_3
  SPLIT_4
  MONTHLY
  CUSTOM
}

enum PaymentMethod {
  STRIPE
  BANK_TRANSFER
  CASH
  PAYPAL
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum WaitlistStatus {
  WAITING
  OFFERED
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum ActivityType {
  STUDENT_CREATED
  SLOT_SELECTED
  SLOT_ASSIGNED
  SLOT_REASSIGNED
  PAYMENT_RECEIVED
  STATUS_CHANGED
  EMAIL_SENT
  EMAIL_RESENT
  NOTE_ADDED
  WAITLIST_JOINED
  WAITLIST_OFFERED
  ARRANGEMENT_CREATED
  SALE_DATA_SYNCED
  ATTENDANCE_RECORDED
}

model Settings {
  id                Int      @id @default(1)
  capacity          Int      @default(12)
  anchorDate        DateTime @default("2026-01-06T00:00:00.000Z")
  showGroupCodes    Boolean  @default(false)
  adminPasswordHash String
  slackWebhookUrl   String?
  resendApiKey      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Slot {
  id           String         @id @default(cuid())
  dayOfWeek    Int
  time         String
  displayName  String
  zoomLink     String?
  isOpen       Boolean        @default(true)
  sortOrder    Int            @default(0)
  gridPosition Int
  instances    SlotInstance[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([dayOfWeek, time])
}

model SlotInstance {
  id              String          @id @default(cuid())
  slotId          String
  slot            Slot            @relation(fields: [slotId], references: [id], onDelete: Cascade)
  weekNumber      Int
  groupCode       String
  students        Student[]
  waitlistEntries WaitlistEntry[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([slotId, weekNumber])
}

model Student {
  id              String        @id @default(cuid())
  firstName       String
  lastName        String
  email           String        @unique
  phone           String
  slotInstanceId  String?
  slotInstance    SlotInstance?  @relation(fields: [slotInstanceId], references: [id])
  firstCallDate   DateTime?
  joinCode        String?       @unique
  status          StudentStatus @default(PROSPECT)
  studentNumber   String?       @unique
  programmeName   String?
  totalAmount     Decimal?      @db.Decimal(10, 2)
  depositAmount   Decimal?      @db.Decimal(10, 2)
  paymentPlanType PaymentPlan?
  referralSource  String?
  closerId        String?
  closer          Closer?       @relation(fields: [closerId], references: [id])
  saleDate        DateTime?
  enrolmentDate   DateTime?
  startDate       DateTime?
  completionDate  DateTime?
  notes           String?
  payments        Payment[]
  arrangements    Arrangement[]
  activityLogs    ActivityLog[]
  waitlistEntries WaitlistEntry[]
  attendances     Attendance[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model WaitlistEntry {
  id              String         @id @default(cuid())
  studentId       String
  student         Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  slotInstanceId  String
  slotInstance    SlotInstance   @relation(fields: [slotInstanceId], references: [id])
  expiresAt       DateTime
  status          WaitlistStatus @default(WAITING)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model Attendance {
  id          String   @id @default(cuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  accessedAt  DateTime @default(now())
  ipAddress   String?
  userAgent   String?

  @@index([studentId, accessedAt])
}

model Closer {
  id           String        @id @default(cuid())
  firstName    String
  lastName     String?
  email        String?       @unique
  phone        String?
  isActive     Boolean       @default(true)
  passwordHash String?
  students     Student[]
  activityLogs ActivityLog[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Payment {
  id               String        @id @default(cuid())
  studentId        String
  student          Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  amount           Decimal       @db.Decimal(10, 2)
  currency         String        @default("GBP")
  method           PaymentMethod?
  status           PaymentStatus @default(PENDING)
  dueDate          DateTime?
  paidDate         DateTime?
  reference        String?
  notes            String?
  instalmentNumber Int?
  totalInstalments Int?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

model Arrangement {
  id          String   @id @default(cuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  description String
  agreedBy    String?
  agreedDate  DateTime @default(now())
  isActive    Boolean  @default(true)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ActivityLog {
  id            String       @id @default(cuid())
  studentId     String?
  student       Student?     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  type          ActivityType
  title         String
  description   String?
  createdByType String?
  closerId      String?
  closer        Closer?      @relation(fields: [closerId], references: [id])
  metadata      Json?
  createdAt     DateTime     @default(now())
}

model Programme {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  price       Decimal? @db.Decimal(10, 2)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
